#!/bin/sh
# 首启执行：写入公钥、禁用 SSH 密码登录（Dropbear）
set -eu

read_only_keys() {
cat <<'EOF'
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOZ4kuQ80iWT+rFYjdWEfMfolBqAxKtwAEsHQkrs1TY1 openwrt-key
# 也可以追加更多行
# ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQ... other
# 注：可以用这个命令生成密钥对 ssh-keygen -t ed25519 -a 64 -f ~/.ssh/openwrt_ed25519 -C "openwrt-key"
EOF
}

install_authorized_keys() {
    # 原来的 install -d -m 0755 /etc/dropbear 改为：
    [ -d /etc/dropbear ] || mkdir -p /etc/dropbear
    chmod 0755 /etc/dropbear || true

    local ak='/etc/dropbear/authorized_keys'
    # 若只想“追加不覆盖”，删掉下一行即可
    # : >"$ak"
    touch "$ak"
    chmod 600 "$ak" || true

    # 逐行追加（跳过空行和注释），避免重复
    read_only_keys | while IFS= read -r line; do
        case "$line" in
            ''|\#*) continue ;;
            *) grep -qxF "$line" "$ak" 2>/dev/null || printf '%s\n' "$line" >>"$ak" ;;
        esac
    done
}

harden_dropbear() {
    uci -q show dropbear >/dev/null 2>&1 || return 0

    # 找出所有 dropbear 实例（如 dropbear.cfg01411a）
    local sections s
    sections="$(uci -q show dropbear | sed -n 's/^dropbear\.\([^=]*\)=dropbear$/\1/p')"

    # 没有实例则补一个
    if [ -z "$sections" ]; then
        s="$(uci add dropbear dropbear)"
        [ -n "$s" ] && sections="$s"
    fi

    for s in $sections; do
        uci set dropbear."$s".PasswordAuth='off'
        uci set dropbear."$s".RootPasswordAuth='off' 2>/dev/null || true
    done
    uci commit dropbear

    /etc/init.d/dropbear enable 2>/dev/null || true
    /etc/init.d/dropbear restart 2>/dev/null || true
}

# === 执行顺序 ===
install_authorized_keys
harden_dropbear
exit 0

